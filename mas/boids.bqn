# utilities
RandArr â† 1000âŠ¸(âŠ£Ã·Ëœâ€¢rand.RangeËœ)

Norm2	â†	(+Â´)âˆ˜(Ã—ËœË˜)âˆ˜-	# norm squared
Norm	â†	âˆšNorm2			# norm
Dist2	â†	Norm2-			# distance squared
Dist	â†	Norm-			# distance

_debug â† {
	â€¢Out "ğ•¨ is"âˆ¾â€¢Repr ğ•¨
	â€¢Out "ğ•© is"âˆ¾â€¢Repr ğ•©
	ğ•¨ğ”½ğ•©
}

# boids
nboids â† 20
boids â† RandArr nboidsâ€¿4	# major cells are âŸ¨x, y, dx, dyâŸ©
boids Ã·âŸœ1000 âŒ¾(Â¯2âŠ¸â†‘Ë˜)â†©		# lower speed for safety, this is a rather scuffed run

# given arrays x y indicating positions
# return array of arrays (thus boxed)
# where every element neigh_i of the result
# is an array of indices of neighbours of x_iâ€¿y_i
# where xi = iâŠ‘x, yi = iâŠ‘y

# TODO: for large boid arrays Dist2âŒœËœ is probably a bad idea
# 
# for if it does allocate an (â‰ â‰boids)â€¿(â‰ â‰boids) shaped array
# and is not fused away somehow... das a lot of memory

# 0â€¿0â‰ picks the diagonal and I still have no idea how that works, but it does
NeighInds â† {d ğ•Š boids:
	xyâ†2â†‘âŒ¾â‰boids
	d2 â† dÃ—d
	/Â¨ <Ë˜ 0Â¨âŒ¾(0â€¿0âŠ¸â‰) d2 > Dist2âŒœËœ <Ë˜ xy 
}

Neighs â† {d ğ•Š boids:
	âŠâŸœ(<Ë˜boids)Â¨ d NeighInds boids
}

Centers â† +Â´Â¨ Ã· 1âŠ¸âŒˆâˆ˜(â‰ Â¨)

ClampVs â† { ğ•Švs: # velocities
    mods â† +Ë Ã—ËœâŒ¾â¥Š â‰vs
	clamped â† 0.00001 âŒˆ 0.001 âŒŠ mods
	clamped Ã— vsÃ·mods
}

Update â† {ğ•Š boids:
    # neightbours
    ns   â† 0.1  Neighs boids
    dncs â† boids - >4âŠ¸â†‘Â¨ Centers ns
    nf   â† Â¯0.008 Ã— 2âŠ¸â†‘Ë˜ dncs
    nf   (0â‰ â‰ Â¨ns)âŠ¸Ã—â†©
    smf  â† Â¯0.3 Ã— Â¯2âŠ¸â†‘Ë˜ dncs
    smf   (0â‰ â‰ Â¨ns)âŠ¸Ã—â†©

    rs   â† 0.05 Neighs boids
    rf   â† 0.05 Ã— 2âŠ¸â†‘Ë˜ boids - >4âŠ¸â†‘Â¨ Centers rs
    rf   (â‰ Â¨rs)âŠ¸Ã—â†©

    xâ€¿yâ€¿dxâ€¿dy â† <Ë˜ â‰boids
    siwf      â† â‰ 0.003 Ã— ((x>0.9) -Ëœ x<0.1) â‰ ((y>0.9) -Ëœ y<0.1)

    nx      â† 0.08 âŒˆ 0.92 âŒŠ x + dx
    ny      â† 0.08 âŒˆ 0.92 âŒŠ y + dy
    ndxâ€¿ndy â† <Ë˜ â‰ ClampVs nf + smf + + rf + siwf + Â¯2âŠ¸â†‘Ë˜boids
    â‰> nxâ€¿nyâ€¿ndxâ€¿ndy
}

# hic est raylib
âŸ¨âŸ¨white, black, red, blueâŸ©â‡colorâŸ©â†râ†â€¢Import "../rayed-bqn/rayed.bqn"
DrawArena â† { ğ•Š@:
          min â† âŒŠÂ´ r.window.GetSize@
		  64â€¿64â€¿64â€¿255 r.draw.Rectangle [0â€¿0, minâ€¿min]
}
DispCoord â† {
    ğ•Šcoords:
    min â† âŒŠÂ´ r.window.GetSize@
    âŒŠ minâŠ¸Ã— coords
}

DrawBoid â† { ğ•Šboid:
    dr â† 5
	xâ€¿y â† DispCoord 2â†‘boid
	dxâ€¿dy â† Norm2âŠ¸Ã·Ëœ 2â†“boid	

    {white r.draw.Circle âŸ¨(âŒŠÂ¨ğ•©)â‹„drâŸ©} xâ€¿y
}

PerFrame â† {
    DrawArena@
    DrawBoidË˜boids
   			 
	boids Updateâ†©
    100|ğ•©+1
}r.draw._withCanvasâŸœblack


PerFrameâ€¢_While_(Â¬r.window.ShouldClose)âˆ˜0 r.window._openAs "Boid"
