# utilities
RandArr â† 1000âŠ¸(âŠ£Ã·Ëœâ€¢rand.RangeËœ)

N2	â†	(+Â´)âˆ˜(Ã—ËœË˜)âˆ˜-	# norm squared
N	â†	âˆšN2				# norm
D2	â†	N2-				# distance squared
D	â†	N-				# distance

_debug â† {
	ğ”½_ğ•£ğ•© :
	â€¢Out "ğ•© is: [" âˆ¾ (â€¢Repr ğ•©)âˆ¾"]"
	res â† ğ”½ğ•©
	â€¢Out "result is: [" âˆ¾ (â€¢Repr res)âˆ¾"]"
	res
	;
	ğ•¨ğ”½_ğ•£ğ•©:
	â€¢Out "ğ•¨ is: [" âˆ¾ (â€¢Repr ğ•¨)âˆ¾"]"
	â€¢Out "ğ•© is: [" âˆ¾ (â€¢Repr ğ•©)âˆ¾"]"
	res â† ğ•¨ğ”½ğ•©
	â€¢Out "result is: [" âˆ¾ (â€¢Repr res)âˆ¾"]"
	res
}

# boids
nboids â† 200 
boids â† { x_y â† RandArr 2â€¿nboids
	      dx_dy â† 10 Ã·Ëœ 0.5-ËœRandArr 2â€¿nboids
	      x_y âˆ¾ dx_dy 
	  	}

# simulation functions and utils
# Neighbour Indices
# return array of arrays where every element neigh_i of the result
# is an array of indices of neighbours of x_iâ€¿y_i where xi = iâŠ‘x, yi = iâŠ‘y

# TODO: for large boid arrays Dist2âŒœËœ is probably a bad idea
# for if it does allocate an (â‰ â‰boids)â€¿(â‰ â‰boids) shaped array
# and is not fused away somehow... das a lot of memory

# NOTE: 0â€¿0âŠ¸â‰ picks the diagonal
# I still have no idea how that works, but it does
Nis â† {d ğ•Š bs: # distance and boids
    xyâ†2â†‘bs
    dq â† dÃ—d
    /Â¨ <Ë˜ 0Â¨âŒ¾(0â€¿0âŠ¸â‰) dq > D2âŒœËœ <Ë˜ â‰ xy 
}

# Neighbours
Ns â† {d ğ•Š bs: # distance and boids
    (âŠâŒ¾â‰âŸœbs)Â¨ d Nis bs
}

# Clamp velocity magnitudes
# while keeping direction and orientation
ClampVs â† { ğ•Švs:				    # velocities
    mags â† +Ë Ã—Ëœ vs					# magnitudes
	# replace zero magnitdes with dummy value
	# to avoid dividng by zero
	# the value will multiply a zero vector so it's irrelevant
	mags {1Â¨âŒ¾((ğ•©=0)âŠ¸/) ğ•©}â†©
	clamp â† 0.00001 âŒˆ 0.001 âŒŠ mags	# clamped magnitudes
	clampâŠ¸Ã—Ë˜ Ã·âŸœmagsË˜ vs
}

# Centers:
# takes a list of neighbour arrays and returns centers shaped
# like how our boid array is shaped (nboidsâ€¿4)
# where first major cell is the average x of neighbours
# (or 0 if no neighbours), then average y, dx, and dy
Cs â† {â‰>(+ËÃ·1âŠ¸âŒˆâˆ˜â‰ )Ë˜Â¨ğ•©}

# Update (simulation tick)
Up â† {ğ•Š bs:
    bns â† 0.35 Ns bs	# list of boid neighbour arrays
	hn â† 0â‰ 1âŠ¸âŠ‘âˆ˜â‰¢Â¨ bns   # does boid have neighbours
    dncs â† bs - Cs bns	# distance to neighbour centers

    nf â† hnâŠ¸Ã—Ë˜ Â¯0.003 Ã— 2â†‘ dncs	# neighbouring force
    smf â† hnâŠ¸Ã—Ë˜ Â¯0.5 Ã— 2â†“ dncs	# speed matching force

    brs â† 0.05 Ns bs	# repelled boids
	nr â† 1âŠ¸âŠ‘âˆ˜â‰¢Â¨ brs		# number of repelled

    rf â† nrâŠ¸Ã—Ë˜ 0.03Ã— 2â†‘ bs - Cs brs 	# repulsive force

    siwf â† 0.003 Ã— (<âŸœ0.1->âŸœ0.9)Ë˜ 2â†‘bs	# "stay in window" force

	nx_y â† 0.05âŒˆ 0.95âŒŠ (2âŠ¸â†‘+2âŠ¸â†“)bs		# next pos
	ndx_dy â† ClampVs rf + nf + smf + siwf + 2â†“bs  # next vel
	nx_y âˆ¾ ndx_dy
} 

# hic est raylib
âŸ¨âŸ¨white,
  black,
  red,
  green,
  blueâŸ© â‡colorâŸ©â†râ†â€¢Import "../rayed-bqn/rayed.bqn"

DrawArena â† { ğ•Š@:
          min â† âŒŠÂ´ r.window.GetSize@
		  64â€¿64â€¿64â€¿255 r.draw.Rectangle [0â€¿0, minâ€¿min]
}

DispCoord â† {ğ•Šnc: # normalized coordinates (ie. âˆŠ (0, 1))
    min â† âŒŠÂ´ r.window.GetSize@
    âŒŠ min Ã— nc
}

# Normalized:
# takes "struct of arrays" style matrix
# (one major cell per axis of elements)
# and normalizes the elements
Nd â† {(âˆš+ËÃ—Ëœğ•©)âŠ¸(Ã·Ëœ)Ë˜ ğ•©}

DrawBoids â† { ğ•Šbs:
    h â† 16 # triangle height
    w â† 8 # triangle width
    x_y â† DispCoord 2â†‘bs
    ndx_dy â† Nd 2â†“bs # normalized

    tips â†  âŒŠx_y + h Ã—  ndx_dy
    left â† 	âŒŠx_y + w Ã— âŒ½ Â¯1âŠ¸Ã—âŒ¾âŠndx_dy
    right â† âŒŠx_y - w Ã— âŒ½ Â¯1âŠ¸Ã—âŒ¾âŠndx_dy

	f â† 2Ã·Ëœ 1+ Ã·ËœâŸœâ†• â‰ â‰tips # fading
	Fade â† {255Ë˜âŒ¾(Â¯1âŠ¸âŠË˜) âŒŠğ•©âŠ¸Ã—Ë˜f}
    (Fade red) {ğ•¨ r.draw.Circle ğ•©â€¿10}Ë˜ â‰tips
    (Fade green) {ğ•¨ r.draw.Circle ğ•©â€¿6}Ë˜ â‰right
    (Fade blue) {ğ•¨ r.draw.Circle ğ•©â€¿6}Ë˜ â‰left

    # to be added back once I figure out why do the triangles
	# occasionally disappear

    # {white r.draw.Triangle(3â€¿2â¥Šğ•©)}_debugË˜ â‰tipsâˆ¾rightâˆ¾left
}

PerFrame â† {
    DrawArena@
    DrawBoids boids
	boids Upâ†©

    100|ğ•©+1
}r.draw._withCanvasâŸœblack


PerFrameâ€¢_While_(Â¬r.window.ShouldClose)âˆ˜0 r.window._openAs "Boid"
